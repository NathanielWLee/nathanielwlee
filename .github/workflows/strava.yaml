name: Update Strava Stats

on:
  schedule:
    - cron: "0 */12 * * *"   # every 12 hours
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get Strava Access Token
        id: gettoken
        run: |
          RESPONSE=$(curl -s -X POST \
            https://www.strava.com/oauth/token \
            -d client_id=${{ secrets.CLIENT_ID }} \
            -d client_secret=${{ secrets.CLIENT_SECRET }} \
            -d grant_type=refresh_token \
            -d refresh_token=${{ secrets.REFRESH_TOKEN }})

          echo "ACCESS_TOKEN=$(echo $RESPONSE | jq -r .access_token)" >> $GITHUB_ENV

      - name: Fetch activities for this year
        run: |
          YEAR_START=$(date -d "$(date +%Y)-01-01" +%s)
          ACCESS_TOKEN=${ACCESS_TOKEN}

          curl -s -G https://www.strava.com/api/v3/athlete/activities \
            -d after=$YEAR_START \
            -d per_page=200 \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            > strava_raw.json

      - name: Process data
        run: |
          echo "{" > strava.json

          for sport in Run Ride Swim; do
            DIST=$(jq "[.[] | select(.sport_type==\"${sport}\") | .distance] | add // 0" strava_raw.json)
            TIME=$(jq "[.[] | select(.sport_type==\"${sport}\") | .moving_time] | add // 0" strava_raw.json)
            COUNT=$(jq "[.[] | select(.sport_type==\"${sport}\")] | length" strava_raw.json)

            echo "\"${sport}\": {\"distance\": $DIST, \"time\": $TIME, \"count\": $COUNT}," >> strava.json
          done

          echo "\"updated\": \"$(date)\"}" >> strava.json

      - name: Commit results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Strava stats"
          file_pattern: strava.json
